
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aditya's Timeline</title>
    
    <!-- 2D MAP LIBRARIES -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/d3@5.min.js"></script>


    <style>
        /* General Styles */
        :root {
            --primary-color: #4A90E2;
            --background-color-light: #F4F6F8;
            --card-background-light: #FFFFFF;
            --text-color-light: #333333;
            --subtle-text-color-light: #888888;
            --border-color-light: #EAEAEA;
            --background-color-dark: #121212;
            --card-background-dark: #1E1E1E;
            --text-color-dark: #EAEAEA;
            --subtle-text-color-dark: #AAAAAA;
            --border-color-dark: #333333;
            --era-ancient: #C7A678; --era-classical: #D9A375; --era-medieval: #8A9A5B;
            --era-renaissance: #9B59B6; --era-industrial: #7F8C8D; --era-modern: #3498DB;
        }
        
        body {
            --bg-color: var(--background-color-light); --card-bg: var(--card-background-light);
            --text-color: var(--text-color-light); --subtle-text: var(--subtle-text-color-light);
            --border-color: var(--border-color-light);
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
        }

        body[data-theme="dark"] {
            --bg-color: var(--background-color-dark); --card-bg: var(--card-background-dark);
            --text-color: var(--text-color-dark); --subtle-text: var(--subtle-text-color-dark);
            --border-color: var(--border-color-dark);
        }

        /* --- Auth Page --- */
        #auth-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; box-sizing: border-box; }
        #auth-container h1 { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 20px; }
        #auth-container h2 { font-size: 1.5rem; margin-bottom: 25px; font-weight: 500; }
        .auth-form { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 15px; }
        .auth-form input { padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 1rem; }
        .auth-form button { padding: 12px; border-radius: 8px; border: none; background-color: var(--primary-color); color: white; font-size: 1rem; font-weight: 600; cursor: pointer; }
        #auth-container p { margin-top: 25px; color: var(--subtle-text); }
        #auth-container .toggle-auth { color: var(--primary-color); cursor: pointer; font-weight: 600; }
        #auth-error { color: #e74c3c; margin-top: 10px; height: 20px; }

        /* --- Main App Container & Views --- */
        #app-container { display: none; height: 100vh; width: 100%; display: flex; flex-direction: column; }
        main { flex-grow: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .view { display: none; height: 100%; flex-direction: column; flex-grow: 1; }
        .view.active { display: flex; animation: viewFadeIn 0.4s; }
        @keyframes viewFadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Header & Footer --- */
        .app-header { padding: 15px; text-align: center; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; z-index: 10; }
        .app-header h2 { margin: 0; font-size: 1.2rem; }
        .app-footer { 
            flex-shrink: 0; 
            display: flex; justify-content: space-around; background-color: var(--card-bg); border-top: 1px solid var(--border-color); padding: 10px 0; z-index: 50; 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--subtle-text); cursor: pointer; font-size: 0.75rem; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item svg { width: 24px; height: 24px; }
        .scrollable-content { padding: 20px 15px 20px 15px; box-sizing: border-box; flex-grow: 1; overflow-y: auto; }

        /* --- Timeline View --- */
        .era-filters { display: flex; overflow-x: auto; padding: 5px 15px 15px; gap: 10px; -ms-overflow-style: none; scrollbar-width: none; flex-shrink: 0; }
        .era-filters::-webkit-scrollbar { display: none; }
        .era-filter-btn { padding: 8px 15px; border: 1px solid var(--border-color); border-radius: 20px; background-color: var(--card-bg); cursor: pointer; }
        .era-filter-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .timeline { position: relative; padding: 0 15px 0 35px; }
        .timeline::before { content: ''; position: absolute; top: 10px; left: 15px; bottom: 10px; width: 2px; background-color: var(--border-color); }
        .timeline-item { position: relative; margin-bottom: 20px; }
        .timeline-item-dot { position: absolute; left: -20px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background-color: var(--primary-color); border: 2px solid var(--bg-color); }
        .timeline-content { background-color: var(--card-bg); border-radius: 10px; padding: 15px; cursor: pointer; }
        .timeline-year { font-size: 1.5rem; font-weight: 600; }
        .timeline-title { font-size: 1.1rem; font-weight: 600; margin: 5px 0 10px; }
        .timeline-meta { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.85rem; color: var(--subtle-text); }
        .era-tag { padding: 4px 8px; border-radius: 5px; color: white; font-size: 0.75rem; }
        .timeline-description { line-height: 1.5; }
        .era-Ancient { background-color: var(--era-ancient); } .era-Classical { background-color: var(--era-classical); } .era-Medieval { background-color: var(--era-medieval); } .era-Renaissance { background-color: var(--era-renaissance); } .era-Industrial { background-color: var(--era-industrial); } .era-Modern { background-color: var(--era-modern); }

        /* --- Compare View --- */
        .year-selector { display: flex; justify-content: space-between; margin-bottom: 20px; gap: 10px; }
        .year-btn { flex-grow: 1; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--card-bg); cursor: pointer; }
        .search-year-input { width: 100%; padding: 12px; border-radius: 8px; border: 1.5px solid #cccccc; font-size: 1rem; margin-bottom: 15px; box-sizing: border-box; }
        .continent-container { margin-bottom: 25px; }
        .continent-header { padding: 10px 12px; border-radius: 8px; color: white; font-weight: 500; display: inline-block; margin-bottom: 5px; font-size: 1.1rem; }
        .continent-Europe { background-color: #3498DB; } .continent-Asia { background-color: #E74C3C; } .continent-North_America, .continent-South_America { background-color: #2ECC71; } .continent-Africa { background-color: #F39C12; } .continent-Oceania { background-color: #9B59B6; } .continent-Antarctica { background-color: #bdc3c7;}
        .country-timeline { position: relative; padding-left: 20px; margin-bottom: 15px; }
        .country-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .country-header img { width: 24px; height: auto; border-radius: 3px; background-color: var(--border-color); }
        .country-header span { font-weight: 600; font-size: 1rem; }
        .country-content ul { padding-left: 20px; margin: 0; } .country-content li { margin-bottom: 8px; }
        .event-placeholder { color: var(--subtle-text); font-style: italic; }
        .clickable-event { color: var(--primary-color); cursor: pointer; text-decoration: none; }
        .clickable-event:hover { text-decoration: underline; }
        .show-more-btn { display: block; width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--primary-color); background-color: transparent; color: var(--primary-color); font-weight: 600; cursor: pointer; }
        .loader { margin: 40px auto; border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .small-loader { display: inline-block; border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid var(--primary-color); width: 14px; height: 14px; animation: spin 1s linear infinite; margin-left: 5px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Styles for new continent selectors */
        .continent-selector-container { margin-bottom: 10px; }
        button.continent-header { width: 100%; text-align: left; border: none; cursor: pointer; font-size: 1.2rem; }
        .continent-events-container { padding: 10px 0 10px 15px; }
        
        /* --- Map View --- */
        .map-scrubber-container { display: flex; overflow-x: auto; padding: 10px 15px; gap: 10px; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); -ms-overflow-style: none; scrollbar-width: none; flex-shrink: 0; }
        .map-scrubber-container::-webkit-scrollbar { display: none; }
        .scrubber-btn { padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 20px; background-color: var(--bg-color); font-size: 0.9rem; white-space: nowrap; cursor: pointer; }
        .scrubber-btn.active, .scrubber-btn:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        .map-wrapper { flex-grow: 1; position: relative; }
        #map-container, #map-iframe-container { width: 100%; height: 100%; }
        #map-iframe { width: 100%; height: 100%; border: none; }


        /* --- Profile View --- */
        .profile-header { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 20px; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-color); display: flex; justify-content: center; align-items: center; color: white; font-size: 2.5rem; }
        .profile-header h3 { margin: 10px 0 0; } .profile-header .email { color: var(--subtle-text); }
        .profile-stats { display: flex; justify-content: space-around; text-align: center; padding: 20px 0; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); margin: 20px 0; }
        .stat-item .count { font-size: 1.2rem; font-weight: 600; } .stat-item .label { font-size: 0.8rem; color: var(--subtle-text); }
        .profile-section { margin: 20px 0; padding: 0 15px; } .profile-section h4 { text-transform: uppercase; color: var(--subtle-text); }
        .profile-list { background-color: var(--card-bg); border-radius: 10px; overflow: hidden; }
        .profile-list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .profile-list-item:last-child { border-bottom: none; }
        .profile-list-item .icon { margin-right: 15px; } .profile-list-item .text { flex-grow: 1; } .profile-list-item .arrow { color: var(--subtle-text); }
        .sign-out-btn { display: block; width: calc(100% - 30px); margin: 30px auto 0; padding: 15px; border-radius: 10px; background-color: #ffdddd; color: #E74C3C; font-weight: 600; cursor: pointer; text-align: center; border: none; }
        body[data-theme="dark"] .sign-out-btn { background-color: #2e1a1a; }
        .settings-fab { position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; background-color: var(--card-bg); border-radius: 50%; display: none; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid var(--border-color); z-index: 100; }
        
        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: var(--card-bg); margin: 40% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; } .close-btn { font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body ul { padding-left: 20px; } .modal-body li { margin-bottom: 10px; }
        .qa-pair { display: none; } .qa-pair.active { display: block; }
        .qa-navigation-btn { display: block; width: 100%; padding: 12px; margin-top: 20px; border-radius: 8px; border: none; background-color: var(--primary-color); color: white; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>
    <div id="auth-container">
        <h1>Aditya's Timeline</h1>
        <div id="login-form" class="auth-form">
            <h2>Login</h2><input type="email" id="login-email" placeholder="Email" required><input type="password" id="login-password" placeholder="Password" required><button id="login-button">Log In</button>
        </div>
        <div id="signup-form" class="auth-form" style="display: none;">
            <h2>Sign Up</h2><input type="email" id="signup-email" placeholder="Email" required><input type="password" id="signup-password" placeholder="Password" required><button id="signup-button">Sign Up</button>
        </div>
        <p id="auth-error"></p>
        <p><span id="toggle-text">Don't have an account? </span><span id="toggle-auth-button" class="toggle-auth">Sign Up</span></p>
    </div>

    <div id="app-container" style="display:none;">
        <main>
            <div id="timeline-view" class="view">
                <header class="app-header"><h2>Historical Timeline</h2></header>
                <div class="era-filters" id="era-filters"><button class="era-filter-btn active" data-era="All">All Eras</button><button class="era-filter-btn" data-era="Ancient">Ancient</button><button class="era-filter-btn" data-era="Classical">Classical</button><button class="era-filter-btn" data-era="Medieval">Medieval</button><button class="era-filter-btn" data-era="Renaissance">Renaissance</button><button class="era-filter-btn" data-era="Industrial">Industrial</button><button class="era-filter-btn" data-era="Modern">Modern</button></div>
                <div class="scrollable-content" style="padding-top:0;"><div id="timeline-container" class="timeline"></div></div>
            </div>
            <div id="compare-view" class="view">
                <header class="app-header"><h2>Global Timeline</h2></header>
                <div class="scrollable-content">
                    <p>Simultaneous events worldwide. Use formats like `1526 AD` or `44 BC`.</p><input type="text" id="search-year-input" class="search-year-input" placeholder="Enter a year (e.g., 1947 AD, 44 BC)"><div class="year-selector" id="year-selector"><button class="year-btn" data-year="1500 AD">1500</button><button class="year-btn" data-year="1800 AD">1800</button><button class="year-btn" data-year="1900 AD">1900</button><button class="year-btn" data-year="1950 AD">1950</button><button class="year-btn" data-year="2000 AD">2000</button></div>
                    <div id="global-timeline-container"></div>
                </div>
            </div>
            <div id="map-view" class="view">
                <header class="app-header"><h2 id="map-title-header">Historical Map</h2></header>
                <div class="map-scrubber-container" id="map-scrubber"></div>
                <div class="map-wrapper">
                    <div id="map-iframe-container"><iframe id="map-iframe"></iframe></div>
                    <div id="map-container"></div>
                </div>
            </div>
            <div id="profile-view" class="view">
                <div class="scrollable-content">
                    <div class="profile-header"><div class="profile-avatar">A</div><h3>Aditya's Timeline</h3><span class="email" id="user-email"></span></div><div class="profile-stats"><div class="stat-item"><span class="count" id="events-count">0</span><span class="label">Events Explored</span></div><div class="stat-item"><span class="count" id="eras-count">0</span><span class="label">Eras Studied</span></div><div class="stat-item"><span class="count" id="regions-count">7</span><span class="label">Regions</span></div></div><div class="profile-section"><h4>PREFERENCES</h4><div class="profile-list"><div class="profile-list-item"><span class="icon">üîî</span><div class="text">Notifications</div><span class="arrow">&gt;</span></div><div id="theme-btn" class="profile-list-item"><span class="icon">üé®</span><div class="text">Theme <br><span id="theme-subtext" class="subtext" style="font-size: 0.8rem;"></span></div><span class="arrow">&gt;</span></div><div class="profile-list-item"><span class="icon">‚ùì</span><div class="text">Language</div><span class="arrow">&gt;</span></div></div></div><div class="profile-section"><h4>ABOUT</h4><div class="profile-list"><div id="guide-btn" class="profile-list-item"><span class="icon">üëã</span><div class="text">User Guide</div><span class="arrow">‚Üó</span></div><div id="about-btn" class="profile-list-item"><span class="icon">‚ÑπÔ∏è</span><div class="text">About</div><span class="arrow">‚Üó</span></div><div id="privacy-btn" class="profile-list-item"><span class="icon">‚úîÔ∏è</span><div class="text">Privacy Policy</div><span class="arrow">‚Üó</span></div></div></div><button id="sign-out-btn" class="sign-out-btn">Sign Out</button>
                </div>
                <div id="settings-fab" class="settings-fab">‚öôÔ∏è</div>
            </div>
        </main>
        <footer class="app-footer"><div class="nav-item active" data-view="timeline-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2C6.486,2,2,6.486,2,12s4.486,10,10,10s10-4.486,10-10S17.514,2,12,2z M12,20c-4.411,0-8-3.589-8-8s3.589-8,8-8 s8,3.589,8,8S16.411,20,12,20z M13,7h-2v6h5v-2h-3V7z"/></svg><span>Timeline</span></div><div class="nav-item" data-view="compare-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12.71,7.03C12.55,6.86,12.33,6.77,12.1,6.77H4.33c-0.24,0-0.45,0.09-0.61,0.25 C3.56,7.18,3.47,7.4,3.47,7.63v4.54c0,0.24,0.09,0.45,0.25,0.61c0.16,0.16,0.38,0.25,0.61,0.25h1.82v4.55 c0,0.23,0.09,0.44,0.25,0.6c0.16,0.16,0.38,0.25,0.61,0.25h4.55c0.23,0,0.44-0.09,0.6-0.25c0.16-0.16,0.25-0.37,0.25-0.6V8.25 l3.18-3.18C16.91,4.71,16.51,4.3,16.03,4.3C15.54,4.3,15.15,4.71,14.78,5.07L12.71,7.03z M11.18,17.27H7.55V8.25h3.64V17.27z M19.67,7.25c-0.16-0.16-0.38-0.25-0.61-0.25H11.8v1.82h7.27v7.27h-7.27v1.82h7.86c0.24,0,0.45-0.09,0.61-0.25 c0.16-0.16,0.25-0.38,0.25-0.61V7.87C20.5,7.64,20.42,7.43,20.26,7.26L19.67,7.25z"/></svg><span>Compare</span></div><div class="nav-item" data-view="map-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2C6.486,2,2,6.486,2,12s4.486,10,10,10c5.514,0,10-4.486,10-10S17.514,2,12,2z M17.93,15.22 C16.13,13.88,13.4,13.2,12,13.2s-4.13,0.68-5.93,2.02C4.6,13.81,4,11.4,4,10c0-4.411,3.589-8,8-8s8,3.589,8,8 C20,11.4,19.4,13.81,17.93,15.22z"/></svg><span>Map</span></div><div class="nav-item" data-view="profile-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2C6.486,2,2,6.486,2,12s4.486,10,10,10s10-4.486,10-10S17.514,2,12,2z M12,4c1.93,0,3.5,1.57,3.5,3.5S13.93,11,12,11 s-3.5-1.57-3.5-3.5S10.07,4,12,4z M12,20c-2.481,0-4.705-1.025-6.289-2.711C7.294,15.42,9.54,14,12,14s4.706,1.42,6.289,3.289 C16.705,18.975,14.481,20,12,20z"/></svg><span>Profile</span></div></footer>
    </div>
    <div id="info-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="info-modal-title"></h3><span class="close-btn">&times;</span></div><div class="modal-body" id="info-modal-body"></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCgcXgla_mbVSYyOCldV7PeoahHUgp1iuY", authDomain: "las-card.firebaseapp.com", projectId: "las-card" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        
        // DEKHIYE! Humne yahan se saari API keys hata di hain. Ab sab kuch safe hai.
        
        const timelineData = [ { year: -3500, title: "Invention of the Wheel", location: "Mesopotamia", era: "Ancient", description: "The invention of the wheel revolutionizes transport and pottery making." }, { year: -3200, title: "Invention of Writing", location: "Sumer", era: "Ancient", description: "The cuneiform writing system is developed, marking the beginning of recorded history." }, { year: -2560, title: "Great Pyramid of Giza", location: "Egypt", era: "Ancient", description: "Construction of the Great Pyramid, an architectural marvel, is completed." }, { year: 80, title: "Colosseum Opens", location: "Rome", era: "Classical", description: "The Colosseum opens in Rome for gladiatorial games and public spectacles." }, { year: 105, title: "Invention of Paper", location: "China", era: "Classical", description: "Cai Lun invents a paper-making process, transforming the spread of information." }, { year: 476, title: "Fall of the Roman Empire", location: "Europe", era: "Medieval", description: "The Western Roman Empire collapses, marking the beginning of the Middle Ages." }, { year: 850, title: "Discovery of Gunpowder", location: "China", era: "Medieval", description: "Alchemists in China discover gunpowder, initially for medicinal purposes, later for warfare." }, { year: 1215, title: "Magna Carta is Signed", location: "England", era: "Medieval", description: "A foundational document for constitutional law and human rights." }, { year: 1440, title: "Invention of the Printing Press", location: "Germany", era: "Renaissance", description: "Johannes Gutenberg's invention sparks an information revolution in Europe." }, { year: 1543, title: "Copernicus' Heliocentric Model", location: "Poland", era: "Renaissance", description: "Nicolaus Copernicus publishes his theory that the Earth revolves around the Sun." }, { year: 1609, title: "Galileo's Telescope Observations", location: "Italy", era: "Renaissance", description: "Galileo Galilei's observations of the cosmos provide evidence for the Copernican model." }, { year: 1687, title: "Newton's Principia Mathematica", location: "England", era: "Renaissance", description: "Isaac Newton publishes his laws of motion and universal gravitation, a cornerstone of physics." }, { year: 1712, title: "Invention of the Steam Engine", location: "England", era: "Industrial", description: "Thomas Newcomen's atmospheric steam engine paves the way for the Industrial Revolution." }, { year: 1760, title: "Industrial Revolution Begins", location: "Britain", era: "Industrial", description: "Transforms society with new manufacturing processes and technologies." }, { year: 1776, title: "American Independence", location: "USA", era: "Industrial", description: "The Declaration of Independence is signed, creating the United States." }, { year: 1783, title: "First Hot Air Balloon Flight", location: "France", era: "Industrial", description: "The Montgolfier brothers achieve the first manned, untethered flight, marking the dawn of aviation." }, { year: 1796, title: "Discovery of Vaccination", location: "England", era: "Industrial", description: "Edward Jenner develops the first vaccine, using cowpox to immunize against smallpox." }, { year: 1837, title: "Invention of the Telegraph", location: "USA", era: "Industrial", description: "Samuel Morse develops the electric telegraph, enabling long-distance communication." }, { year: 1859, title: "Darwin's \"On the Origin of Species\"", location: "England", era: "Industrial", description: "Charles Darwin publishes his theory of evolution by natural selection." }, { year: 1876, title: "Bell Patents the Telephone", location: "USA", era: "Industrial", description: "Alexander Graham Bell is granted a patent for the telephone." }, { year: 1879, title: "Edison's Light Bulb", location: "USA", era: "Industrial", description: "Thomas Edison patents a commercially viable incandescent light bulb." }, { year: 1903, title: "First Powered Flight", location: "USA", era: "Modern", description: "The Wright Brothers achieve the first successful powered and controlled airplane flight." }, { year: 1905, title: "Einstein's Theory of Relativity", location: "Switzerland", era: "Modern", description: "Albert Einstein publishes his theory of special relativity, changing our understanding of space and time." }, { year: 1926, title: "First Liquid-Fueled Rocket", location: "USA", era: "Modern", description: "Robert Goddard launches the world's first liquid-fueled rocket." }, { year: 1928, title: "Discovery of Penicillin", location: "Scotland", era: "Modern", description: "Alexander Fleming discovers penicillin, the first true antibiotic." }, { year: 1942, title: "First Controlled Nuclear Reaction", location: "USA", era: "Modern", description: "Enrico Fermi leads a team to achieve the first self-sustaining nuclear chain reaction." }, { year: 1947, title: "Invention of the Transistor", location: "USA", era: "Modern", description: "Bell Labs scientists invent the transistor, the foundation of all modern electronics." }, { year: 1953, title: "Discovery of DNA Structure", location: "England", era: "Modern", description: "Watson and Crick describe the double helix structure of DNA." }, { year: 1957, title: "Sputnik 1 Launch", location: "Soviet Union", era: "Modern", description: "The first artificial satellite is launched, initiating the Space Race." }, { year: 1961, title: "First Human in Space", location: "Soviet Union", era: "Modern", description: "Cosmonaut Yuri Gagarin becomes the first human to orbit the Earth." }, { year: 1969, title: "Apollo 11 Moon Landing", location: "USA/Moon", era: "Modern", description: "NASA's Apollo 11 mission successfully lands the first humans on the Moon." }, { year: 1981, title: "First Space Shuttle Flight", location: "USA", era: "Modern", description: "Space Shuttle Columbia (STS-1) launches, the first flight of a reusable orbital spacecraft." }, { year: 1990, title: "Hubble Telescope Deployed", location: "Space", era: "Modern", description: "The Hubble Space Telescope is deployed, revolutionizing modern astronomy." }, { year: 2021, title: "James Webb Telescope Launch", location: "Space", era: "Modern", description: "The James Webb Space Telescope is launched to observe the first galaxies." }];
        
        const mapFiles = {
            'Harappan Sites': { type: 'markers', key: 'Harappan', year: 'c. 2500-1900 BCE'},
            'Mauryan Empire Sites': { type: 'markers', key: 'Mauryan', year: 'c. 322-185 BCE'},
            'Gupta Empire Sites': { type: 'markers', key: 'Gupta', year: 'c. 320-550 CE'},
            'Delhi Sultanate Cities': { type: 'markers', key: 'Sultanate', year: '1206-1526 CE'},
            'Mughal Empire Cities': { type: 'markers', key: 'Mughal', year: '1526-1857 CE'},
            'Revolt of 1857': { type: 'markers', key: 'Revolt1857', year: '1857 CE'},
            'National Movement': { type: 'markers', key: 'NationalMovement', year: '1857-1947 CE'},
            'Islamic Empire Cities': { type: 'markers', key: 'IslamicEmpire', year: 'c. 632-1258 CE'},
            'Industrial Revolution': { type: 'markers', key: 'IndustrialRevolution', year: 'c. 1760-1840 CE'},
            'Modernisation (East Asia)': { type: 'markers', key: 'Modernisation', year: 'c. 1868-1912 CE'},
            'Roman Empire (Provinces)': { type: 'geojson', year: 'c. 117 CE', url: 'https://raw.githubusercontent.com/barionleg/roman-empire/master/data/provinces.geojson' },
            'Roman Empire (Detailed View)': { type: 'iframe', year: 'c. 117 CE', url: 'https://labs.maptiler.com/roman-empire/#5.19/44.217/13.517/0/2' },
            'World 1880': { type: 'geojson', year: '1880 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/world_maps/world_1880.geojson' },
            'World 1914': { type: 'geojson', year: '1914 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/world_maps/world_1914.geojson' },
            'World 1920': { type: 'geojson', year: '1920 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/world_maps/world_1920.geojson' },
            'World 1938': { type: 'geojson', year: '1938 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/world_maps/world_1938.geojson' },
            'World 1945': { type: 'geojson', year: '1945 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/world_maps/world_1945.geojson' },
            'World 1994': { type: 'geojson', year: '1994 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/world_maps/world_1994.geojson' },
            'Europe 1880 (w/ Rus)': { type: 'geojson', year: '1880 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1880_w_russia.json'},
            'Europe 1880 (w/o Rus)': { type: 'geojson', year: '1880 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1880_wo_russia.json'},
            'Europe 1914 (w/ Rus)': { type: 'geojson', year: '1914 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1914_w_russia.json'},
            'Europe 1914 (w/o Rus)': { type: 'geojson', year: '1914 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1914_wo_russia.json'},
            'Europe 1920 (w/ Rus)': { type: 'geojson', year: '1920 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1920_w_russia.json'},
            'Europe 1920 (w/o Rus)': { type: 'geojson', year: '1920 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1920_wo_russia.json'},
            'Europe 1938 (w/ Rus)': { type: 'geojson', year: '1938 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1938_w_russia.json'},
            'Europe 1938 (w/o Rus)': { type: 'geojson', year: '1938 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1938_wo_russia.json'},
            'Europe 1945 (w/ Rus)': { type: 'geojson', year: '1945 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1945_w_russia.json'},
            'Europe 1945 (w/o Rus)': { type: 'geojson', year: '1945 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1945_wo_russia.json'},
            'Europe 1994': { type: 'geojson', year: '1994 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/europe_maps/europe_1994_w_russia.json'},
            'NH 1880': { type: 'geojson', year: '1880 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/Northern_Hemisphere/NH_1880.json'},
            'NH 1914': { type: 'geojson', year: '1914 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/Northern_Hemisphere/NH_1914.json'},
            'NH 1920': { type: 'geojson', year: '1920 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/Northern_Hemisphere/NH_1920.json'},
            'NH 1938': { type: 'geojson', year: '1938 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/Northern_Hemisphere/NH_1938.json'},
            'NH 1945': { type: 'geojson', year: '1945 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/Northern_Hemisphere/NH_1945.json'},
            'NH 1994': { type: 'geojson', year: '1994 CE', url: 'https://raw.githubusercontent.com/georgestanley/Historical-Maps/main/Northern_Hemisphere/NH_1994.json'},
            'World & India Political Map': { type: 'base', year: 'Present Day'},
            'Tectonic Plates': { type: 'geojson', year: 'Present Day', url: 'https://raw.githubusercontent.com/fraxen/tectonicplates/master/GeoJSON/PB2002_boundaries.json' }
        };
        
        const markerData = {
            Harappan: { 
                view: [28.5, 72.0], zoom: 5, 
                points: [ 
                    { lat: 30.628, lng: 72.871, name: 'Harappa (Punjab, Pakistan)', description: 'The first site to be excavated, giving the civilization its name. Known for its massive granaries, grid-like street plan, and seals that indicate a sophisticated trade network.' }, 
                    { lat: 27.329, lng: 68.138, name: 'Mohenjo-daro (Sindh, Pakistan)', description: 'One of the largest settlements, famous for the "Great Bath," a large public water tank, and highly organized city planning with advanced drainage systems. A UNESCO World Heritage Site.' }, 
                    { lat: 23.887, lng: 70.213, name: 'Dholavira (Gujarat, India)', description: 'Remarkable for its sophisticated water conservation system with large reservoirs and dams, three-part city layout, and one of the world\'s first signboards.' }, 
                    { lat: 22.521, lng: 72.148, name: 'Lothal (Gujarat, India)', description: 'A major port city with a large man-made dockyard, indicating extensive sea trade with Mesopotamia. Known for its bead-making industry.' }, 
                    { lat: 29.475, lng: 74.132, name: 'Kalibangan (Rajasthan, India)', description: 'Known for its "ploughed field," evidence of early ritualistic fire altars, and being a major provincial capital of the Indus Valley Civilization.' },
                    { lat: 29.283, lng: 75.733, name: 'Rakhigarhi (Haryana, India)', description: 'One of the largest Harappan sites, potentially larger than Mohenjo-daro. Excavations have revealed mature Harappan phases with planned townships and fire altars.'}
                ] 
            },
            Mauryan: { 
                view: [26.0, 81.0], zoom: 5, 
                points: [ 
                    { lat: 25.594, lng: 85.137, name: 'Pataliputra (Modern Patna, Bihar)', description: 'The imperial capital of the Mauryan Empire. Described by Greek ambassador Megasthenes in his book *Indica* as a magnificent, fortified city.' }, 
                    { lat: 33.729, lng: 72.788, name: 'Taxila (Takshashila, Pakistan)', description: 'A major provincial capital and a renowned center of learning and philosophy. Kautilya (Chanakya), the advisor to Chandragupta, is said to have taught here.' }, 
                    { lat: 23.182, lng: 75.777, name: 'Ujjain (Modern Ujjain, Madhya Pradesh)', description: 'A key provincial capital governing the western provinces and a major trade center on the route to the sea ports of the west coast.' }, 
                    { lat: 20.27, lng: 85.82, name: 'Kalinga (Modern Odisha)', description: 'Site of the brutal Kalinga War (c. 261 BCE). The immense bloodshed led to Emperor Ashoka\'s conversion to Buddhism and his policy of Dhamma-vijaya (conquest by righteousness).' },
                    { lat: 24.524, lng: 82.845, name: 'Sarnath (near Varanasi, UP)', description: 'The site where the Buddha gave his first sermon. Ashoka erected a magnificent pillar here, the capital of which is now the national emblem of India.'}
                ] 
            },
            Gupta: { 
                view: [25.5, 83.0], zoom: 5.5, 
                points: [ 
                    { lat: 25.594, lng: 85.137, name: 'Pataliputra (Modern Patna, Bihar)', description: 'The capital of the Gupta Empire during its "Golden Age," a center for art, culture, and learning. It was visited by the Chinese pilgrim Faxian.' }, 
                    { lat: 23.182, lng: 75.777, name: 'Ujjain (Modern Ujjain, Madhya Pradesh)', description: 'A virtual second capital under Chandragupta II (Vikramaditya). It was a global hub for astronomy and mathematics, home to scholars like Aryabhata and Varahamihira.' }, 
                    { lat: 25.035, lng: 85.521, name: 'Nalanda (Bihar)', description: 'A world-famous Mahavihara (Buddhist monastery and university) that flourished under the patronage of Gupta rulers, attracting students from across Asia.' },
                    { lat: 24.524, lng: 82.845, name: 'Sarnath (near Varanasi, UP)', description: 'A major center for Gupta art. The serene and spiritually profound Buddha statues from Sarnath are considered masterpieces of Indian art.'},
                    { lat: 25.280, lng: 82.972, name: 'Prayagraj (Allahabad, UP)', description: 'Site of the Prayag Prashasti (Allahabad Pillar inscription), which details the extensive military conquests of Emperor Samudragupta, the "Napoleon of India".'}
                ] 
            },
            Sultanate: { 
                view: [28.6, 77.2], zoom: 7, 
                points: [ 
                    { lat: 28.524, lng: 77.185, name: 'Qutub Minar Complex (Delhi)', description: 'The heart of the Mamluk (Slave) Dynasty. Construction was started by Qutb-ud-din Aibak in 1206. A symbol of the Sultanate\'s establishment.' }, 
                    { lat: 28.59, lng: 77.24, name: 'Siri Fort (Delhi)', description: 'Built by Alauddin Khilji around 1303 to defend Delhi from Mongol invasions. It was the second of the seven cities of medieval Delhi.' },
                    { lat: 28.515, lng: 77.285, name: 'Tughlaqabad Fort (Delhi)', description: 'A massive ruined fort built by Ghiyas-ud-din Tughlaq in 1321. Known for its imposing ramparts and was abandoned shortly after its construction.' },
                    { lat: 19.943, lng: 75.320, name: 'Daulatabad Fort (Devagiri, Maharashtra)', description: 'Muhammad bin Tughlaq infamously tried to move the entire capital here from Delhi in 1327, a disastrous experiment that caused immense hardship.' },
                    { lat: 28.635, lng: 77.224, name: 'Firoz Shah Kotla (Delhi)', description: 'The fifth city of Delhi, built by Firoz Shah Tughlaq in 1354. It houses a polished sandstone Ashokan pillar.'}
                ] 
            },
            Mughal: { 
                view: [27.5, 77.5], zoom: 6, 
                points: [ 
                    { lat: 28.656, lng: 77.241, name: 'Red Fort (Lal Qila, Delhi)', description: 'Built by Shah Jahan, it served as the main residence of the Mughal Emperors for nearly 200 years. The Prime Minister of India hoists the national flag here on Independence Day.' }, 
                    { lat: 27.175, lng: 78.042, name: 'Taj Mahal (Agra, UP)', description: 'An ivory-white marble mausoleum commissioned by Shah Jahan for his wife Mumtaz Mahal. A jewel of Muslim art in India and a UNESCO World Heritage Site.' },
                    { lat: 27.180, lng: 78.021, name: 'Agra Fort (Agra, UP)', description: 'A historical fort that was the main residence of the emperors of the Mughal Dynasty until 1638. A UNESCO World Heritage Site.'},
                    { lat: 27.094, lng: 77.663, name: 'Fatehpur Sikri (Uttar Pradesh)', description: 'The short-lived capital built by Emperor Akbar between 1571 and 1585, known for the Buland Darwaza and its unique blend of architectural styles.' }, 
                    { lat: 31.588, lng: 74.312, name: 'Lahore Fort (Lahore, Pakistan)', description: 'A major citadel in Lahore, rebuilt and embellished by several Mughal emperors like Akbar, Jahangir, and Shah Jahan. Features the iconic Alamgiri Gate.' } 
                ] 
            },
            Revolt1857: { 
                view: [27.0, 80.0], zoom: 6, 
                points: [ 
                    { lat: 28.984, lng: 77.706, name: 'Meerut (Uttar Pradesh)', description: 'The city where the Revolt of 1857 began on May 10, when sepoys openly rebelled against their British officers.' }, 
                    { lat: 28.614, lng: 77.209, name: 'Delhi', description: 'Symbolic heart of the revolt; rebels marched here from Meerut and declared the aging Mughal Emperor Bahadur Shah Zafar their leader.' }, 
                    { lat: 26.449, lng: 80.331, name: 'Kanpur (Cawnpore, Uttar Pradesh)', description: 'A major center of the rebellion led by Nana Saheb. The site of the infamous Bibighar massacre.' }, 
                    { lat: 26.846, lng: 80.946, name: 'Lucknow (Uttar Pradesh)', description: 'Site of a prolonged siege of the British Residency, led by Begum Hazrat Mahal of Awadh.' }, 
                    { lat: 25.435, lng: 78.568, name: 'Jhansi (Uttar Pradesh)', description: 'A key center of resistance led by the iconic Rani Lakshmibai, who became a symbol of bravery and resistance against the British.' }, 
                    { lat: 26.218, lng: 78.182, name: 'Gwalior (Madhya Pradesh)', description: 'Where Rani Lakshmibai fought her last battle and was martyred. The Gwalior Fort was a strategic point captured by the rebels.' } 
                ] 
            },
            NationalMovement: { 
                view: [24.0, 80.0], zoom: 5, 
                points: [
                    { lat: 28.984, lng: 77.706, name: 'Meerut (1857)', description: '1. The Great Revolt (First War of Independence) begins.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1858)', description: '2. Government of India Act transfers power to the British Crown.' },
                    { lat: 23.4735, lng: 88.0411, name: 'Nadia, Bengal (1859)', description: '3. Indigo Revolt (Nil Bidroha) against exploitative planters.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1866)', description: '4. East India Association founded by Dadabhai Naoroji.' },
                    { lat: 18.5204, lng: 73.8567, name: 'Poona (Pune) (1870)', description: '5. Poona Sarvajanik Sabha founded by M.G. Ranade.' },
                    { lat: 11.6643, lng: 92.715, name: 'Port Blair (1872)', description: '6. Lord Mayo, Viceroy of India, is assassinated.' },
                    { lat: 19.0760, lng: 72.8777, name: 'Bombay (Mumbai) (1875)', description: '7. Arya Samaj founded by Swami Dayananda Saraswati.' },
                    { lat: 13.0068, lng: 80.2577, name: 'Adyar, Madras (1875)', description: '8. Theosophical Society HQ established (founded in New York).' },
                    { lat: 22.5726, lng: 88.3639, name: 'Calcutta (Kolkata) (1876)', description: '9. Indian National Association founded by Surendranath Banerjee.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1877)', description: '10. Delhi Durbar held to proclaim Queen Victoria as Empress of India.' },
                    { lat: 22.5726, lng: 88.3639, name: 'Calcutta (Kolkata) (1878)', description: '11. Vernacular Press Act is passed to censor the Indian press.' },
                    { lat: 22.5726, lng: 88.3639, name: 'Calcutta (Kolkata) (1883)', description: '12. Ilbert Bill Controversy.' },
                    { lat: 19.0760, lng: 72.8777, name: 'Bombay (Mumbai) (1885)', description: '13. Indian National Congress (INC) is founded.' },
                    { lat: 22.5726, lng: 88.3639, name: 'Calcutta (Kolkata) (1891)', description: '14. Age of Consent Act passed.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1892)', description: '15. Indian Councils Act is passed.' },
                    { lat: 41.8781, lng: -87.6298, name: 'Chicago, USA (1893)', description: '16. Swami Vivekananda\'s address at the Parliament of World\'s Religions.' },
                    { lat: 19.6633, lng: 75.324, name: 'Deccan Region (1896)', description: '17. Great Famine begins, affecting large parts of India.' },
                    { lat: 22.5393, lng: 88.354, name: 'Belur Math, Calcutta (1897)', description: '18. Ramakrishna Mission founded by Swami Vivekananda.' },
                    { lat: 18.5204, lng: 73.8567, name: 'Pune (1897)', description: '19. Chapekar brothers assassinate British officials.' },
                    { lat: 22.5726, lng: 88.3639, name: 'Calcutta (Kolkata) (1904)', description: '20. Indian Universities Act passed by Lord Curzon.' },
                    { lat: 23.8103, lng: 90.4125, name: 'Dhaka, Bengal (1905)', description: '21. Partition of Bengal by Lord Curzon.' },
                    { lat: 22.5726, lng: 88.3639, name: 'Calcutta (Kolkata) (1905)', description: '22. Launch of the Swadeshi and Boycott Movement.' },
                    { lat: 23.8103, lng: 90.4125, name: 'Dacca (Dhaka) (1906)', description: '23. All-India Muslim League is founded.' },
                    { lat: 21.1702, lng: 72.8311, name: 'Surat (1907)', description: '24. Surat Split: Congress divides into Moderates and Extremists.' },
                    { lat: 22.589, lng: 88.341, name: 'Alipore, Calcutta (1908)', description: '25. Alipore Bomb Case involving Aurobindo Ghosh.' },
                    { lat: 19.0760, lng: 72.8777, name: 'Bombay (Mumbai) (1908)', description: '26. Bal Gangadhar Tilak is sentenced to six years in prison.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1909)', description: '27. Morley-Minto Reforms introduce separate electorates.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1911)', description: '28. Partition of Bengal is annulled.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1911)', description: '29. British capital is officially shifted from Calcutta to Delhi.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1912)', description: '30. Delhi Conspiracy Case: Bomb thrown at Viceroy Hardinge.' },
                    { lat: 37.7749, lng: -122.4194, name: 'San Francisco, USA (1913)', description: '31. Ghadar Party is formed by Lala Har Dayal.' },
                    { lat: 22.456, lng: 88.32, name: 'Budge Budge, Calcutta (1914)', description: '32. Komagata Maru incident.' },
                    { lat: 48.8566, lng: 2.3522, name: 'Europe (1914)', description: '33. World War I begins, impacting India.' },
                    { lat: 19.0760, lng: 72.8777, name: 'Bombay (Mumbai) (1915)', description: '34. Mahatma Gandhi returns to India from South Africa.' },
                    { lat: 25.3176, lng: 82.9739, name: 'Varanasi (1916)', description: '35. Banaras Hindu University (BHU) is founded.' },
                    { lat: 26.8467, lng: 80.9462, name: 'Lucknow (1916)', description: '36. Lucknow Pact between Congress and the Muslim League.' },
                    { lat: 18.5204, lng: 73.8567, name: 'Pune & Madras (1916)', description: '37. Home Rule Leagues founded by Tilak and Annie Besant.' },
                    { lat: 26.58, lng: 84.9, name: 'Champaran (1917)', description: '38. Champaran Satyagraha, Gandhi\'s first Satyagraha in India.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1917)', description: '39. Montagu Declaration.' },
                    { lat: 22.75, lng: 72.87, name: 'Kheda (1918)', description: '40. Kheda Satyagraha in Gujarat.' },
                    { lat: 23.0225, lng: 72.5714, name: 'Ahmedabad (1918)', description: '41. Ahmedabad Mill Strike.' },
                    { lat: 48.8566, lng: 2.3522, name: 'Europe (1918)', description: '42. World War I ends.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1919)', description: '43. Rowlatt Act passed.' },
                    { lat: 31.6200, lng: 74.8765, name: 'Amritsar (1919)', description: '44. Jallianwala Bagh Massacre.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1919)', description: '45. Government of India Act (Montagu-Chelmsford Reforms).' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi/Turkey (1919)', description: '46. Khilafat Movement begins.' },
                    { lat: 22.5726, lng: 88.3639, name: 'Calcutta (1920)', description: '47. Non-Cooperation Movement is launched.' },
                    { lat: 19.0760, lng: 72.8777, name: 'Bombay (1920)', description: '48. All India Trade Union Congress (AITUC) founded.' },
                    { lat: 11.0, lng: 76.0, name: 'Malabar, Kerala (1921)', description: '49. Moplah (Malabar) Rebellion.' },
                    { lat: 26.305, lng: 83.373, name: 'Chauri Chaura (1922)', description: '50. Chauri Chaura incident; Gandhi suspends the movement.' },
                    { lat: 23.0225, lng: 72.5714, name: 'Ahmedabad (1922)', description: '51. Gandhi is arrested for sedition.' },
                    { lat: 25.4358, lng: 81.8463, name: 'Allahabad (Prayagraj) (1923)', description: '52. Swaraj Party is formed by C.R. Das and Motilal Nehru.' },
                    { lat: 9.658, lng: 76.518, name: 'Vaikom, Kerala (1924)', description: '53. Vaikom Satyagraha for temple entry rights.' },
                    { lat: 15.8497, lng: 74.4977, name: 'Belgaum (1924)', description: '54. Belgaum session of Congress, presided over by Gandhi.' },
                    { lat: 26.9, lng: 80.8, name: 'Kakori (1925)', description: '55. Kakori Conspiracy train robbery.' },
                    { lat: 21.1458, lng: 79.0882, name: 'Nagpur (1925)', description: '56. Rashtriya Swayamsevak Sangh (RSS) is founded.' },
                    { lat: 26.4499, lng: 80.3319, name: 'Kanpur (1925)', description: '57. Communist Party of India is formally founded.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1927)', description: '58. Simon Commission is appointed.' },
                    { lat: 31.5204, lng: 74.3587, name: 'Lahore (1928)', description: '59. Protests against Simon Commission; death of Lala Lajpat Rai.' },
                    { lat: 26.8467, lng: 80.9462, name: 'Lucknow (1928)', description: '60. Nehru Report is published.' },
                    { lat: 21.695, lng: 73.015, name: 'Bardoli (1928)', description: '61. Bardoli Satyagraha led by Sardar Patel.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1929)', description: '62. Jinnah presents his "Fourteen Points".' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi Assembly (1929)', description: '63. Bhagat Singh and B.K. Dutt bomb the Central Legislative Assembly.' },
                    { lat: 31.5204, lng: 74.3587, name: 'Lahore Jail (1929)', description: '64. Jatin Das dies after a 63-day hunger strike.' },
                    { lat: 31.5204, lng: 74.3587, name: 'Lahore (1929)', description: '65. Lahore Congress session declares Purna Swaraj (Complete Independence).' },
                    { lat: 28.6139, lng: 77.2090, name: 'Across India (1930)', description: '66. January 26 is celebrated as the first Independence Day.' },
                    { lat: 23.0225, lng: 72.5714, name: 'Sabarmati Ashram (1930)', description: '67. Dandi March (Salt March) begins.' },
                    { lat: 20.931, lng: 70.457, name: 'Dandi (1930)', description: '68. Civil Disobedience Movement is launched.' },
                    { lat: 22.346, lng: 91.812, name: 'Chittagong (1930)', description: '69. Chittagong Armoury Raid by Surya Sen.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1930)', description: '70. First Round Table Conference.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1931)', description: '71. Gandhi-Irwin Pact is signed.' },
                    { lat: 31.5204, lng: 74.3587, name: 'Lahore (1931)', description: '72. Execution of Bhagat Singh, Sukhdev, and Rajguru.' },
                    { lat: 24.8607, lng: 67.0011, name: 'Karachi (1931)', description: '73. Karachi session of Congress.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1931)', description: '74. Second Round Table Conference.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1932)', description: '75. Communal Award by Ramsay MacDonald.' },
                    { lat: 18.5204, lng: 73.8567, name: 'Yerwada Jail, Pune (1932)', description: '76. Poona Pact between Gandhi and Ambedkar.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1932)', description: '77. Third Round Table Conference.' },
                    { lat: 52.2370, lng: -0.9028, name: 'Cambridge, UK (1933)', description: '78. Pakistan Declaration pamphlet published by Choudhry Rahmat Ali.' },
                    { lat: 25.5941, lng: 85.1376, name: 'Patna (1934)', description: '79. Civil Disobedience Movement is withdrawn.' },
                    { lat: 19.0760, lng: 72.8777, name: 'Bombay (1934)', description: '80. Congress Socialist Party is formed.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1934)', description: '81. Reserve Bank of India Act is passed.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1935)', description: '82. Government of India Act 1935 is passed.' },
                    { lat: 26.8467, lng: 80.9462, name: 'Lucknow (1936)', description: '83. All India Kisan Sabha is formed.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Across India (1937)', description: '84. Provincial elections; Congress forms ministries.' },
                    { lat: 21.9974, lng: 72.933, name: 'Haripura, Gujarat (1938)', description: '85. Haripura session of Congress; Subhas Chandra Bose elected president.' },
                    { lat: 23.11, lng: 79.95, name: 'Tripuri, MP (1939)', description: '86. Tripuri Crisis; Bose resigns.' },
                    { lat: 22.5726, lng: 88.3639, name: 'Calcutta (1939)', description: '87. Subhas Chandra Bose forms the Forward Bloc.' },
                    { lat: 50.0755, lng: 14.4378, name: 'Europe (1939)', description: '88. World War II begins; Congress ministries resign.' },
                    { lat: 31.5204, lng: 74.3587, name: 'Lahore (1940)', description: '89. Lahore Resolution (Pakistan Resolution) by the Muslim League.' },
                    { lat: 30.3752, lng: 69.3451, name: 'Shimla (1940)', description: '90. August Offer by Viceroy Linlithgow.' },
                    { lat: 18.27, lng: 79.54, name: 'Paunar Ashram, Maharashtra (1940)', description: '91. Individual Satyagraha is launched.' },
                    { lat: 22.5726, lng: 88.3639, name: 'Calcutta (1941)', description: '92. Subhas Chandra Bose escapes from India.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1942)', description: '93. Cripps Mission arrives in India.' },
                    { lat: 18.9647, lng: 72.822, name: 'Gowalia Tank, Bombay (1942)', description: '94. Quit India Resolution passed.' },
                    { lat: 19.0760, lng: 72.8777, name: 'Bombay & Across India (1942)', description: '95. Quit India Movement begins; major leaders arrested.' },
                    { lat: 1.3521, lng: 103.8198, name: 'Southeast Asia (1942)', description: '96. Indian National Army (INA) is formed.' },
                    { lat: 1.3521, lng: 103.8198, name: 'Singapore (1943)', description: '97. Subhas Chandra Bose takes leadership of INA.' },
                    { lat: 1.3521, lng: 103.8198, name: 'Singapore (1943)', description: '98. Provisional Government of Free India (Azad Hind) is formed.' },
                    { lat: 23.7, lng: 89.0, name: 'Bengal (1943)', description: '99. Bengal Famine.' },
                    { lat: 24.585, lng: 93.936, name: 'Moirang, Manipur (1944)', description: '100. INA hoists the Indian flag on Indian soil.' },
                    { lat: 31.1048, lng: 77.1734, name: 'Shimla (1945)', description: '101. Wavell Plan and Shimla Conference.' },
                    { lat: 35.6762, lng: 139.6503, name: 'Tokyo Bay (1945)', description: '102. World War II ends.' },
                    { lat: 28.6562, lng: 77.2410, name: 'Red Fort, Delhi (1945-46)', description: '103. INA Trials.' },
                    { lat: 19.0760, lng: 72.8777, name: 'Bombay (Mumbai) (1946)', description: '104. Royal Indian Navy (RIN) Mutiny.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1946)', description: '105. Cabinet Mission arrives in India.' },
                    { lat: 22.5726, lng: 88.3639, name: 'Calcutta (Kolkata) (1946)', description: '106. Direct Action Day leads to widespread riots.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1946)', description: '107. Interim Government is formed with Nehru as head.' },
                    { lat: 28.6144, lng: 77.212, name: 'Delhi (1946)', description: '108. Constituent Assembly holds its first meeting.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1947)', description: '109. Prime Minister Attlee\'s declaration of British withdrawal.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1947)', description: '110. Mountbatten Plan (June 3 Plan) for partition.' },
                    { lat: 51.5072, lng: -0.1276, name: 'London (1947)', description: '111. Indian Independence Act is passed.' },
                    { lat: 28.6139, lng: 77.2090, name: 'Delhi (1947)', description: '112. Partition of India and Independence on August 15.' },
                ]
            },
            IslamicEmpire: { 
                view: [28.0, 42.0], zoom: 4, 
                points: [ 
                    { lat: 21.422, lng: 39.826, name: 'Mecca (Modern Saudi Arabia)', description: 'The birthplace of Prophet Muhammad and the holiest city in Islam, site of the Kaaba.' }, 
                    { lat: 24.470, lng: 39.610, name: 'Medina (Modern Saudi Arabia)', description: 'The city where Prophet Muhammad established the first Islamic state (Ummah) after the Hijra (migration).' }, 
                    { lat: 33.513, lng: 36.276, name: 'Damascus (Modern Syria)', description: 'The capital of the Umayyad Caliphate (661-750 CE), which oversaw a vast expansion of the empire.' }, 
                    { lat: 33.315, lng: 44.366, name: 'Baghdad (Modern Iraq)', description: 'Capital of the Abbasid Caliphate (750-1258 CE) and the intellectual center of the world during the Islamic Golden Age.' },
                    { lat: 30.044, lng: 31.235, name: 'Cairo (Modern Egypt)', description: 'Founded by the Fatimid Caliphate, it became a major center of learning, culture, and politics in the Islamic world.'}
                ] 
            },
            IndustrialRevolution: { 
                view: [53.0, -1.8], zoom: 7, 
                points: [ 
                    { lat: 53.480, lng: -2.242, name: 'Manchester, UK', description: 'Known as "Cottonopolis," the world\'s first industrial city, dominated by textile manufacturing and factories.' }, 
                    { lat: 52.486, lng: -1.890, name: 'Birmingham, UK', description: 'A major center for iron, steel, and manufacturing, known as the "City of a Thousand Trades." James Watt pioneered the steam engine here.' },
                    { lat: 53.800, lng: -1.549, name: 'Leeds, UK', description: 'A major center for the woollen industry, which mechanized rapidly during the revolution.'}
                ] 
            },
            Modernisation: { 
                view: [36.0, 128.0], zoom: 4, 
                points: [ 
                    { lat: 35.689, lng: 139.691, name: 'Tokyo, Japan', description: 'Transformed from feudal Edo into a modern industrial powerhouse during the Meiji Restoration (1868), adopting Western technology and political systems.' }, 
                    { lat: 39.904, lng: 116.407, name: 'Beijing, China', description: 'The capital of the Qing Dynasty, which faced internal rebellions (Taiping) and external conflicts with Western powers (Opium Wars), leading to forced modernization.' }, 
                    { lat: 31.230, lng: 121.473, name: 'Shanghai, China', description: 'Grew into a major international commercial hub after the Treaty of Nanking (1842) opened it to foreign trade, becoming a symbol of Western influence.' } 
                ] 
            },
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            const authContainer = document.getElementById('auth-container'), appContainer = document.getElementById('app-container');
            auth.onAuthStateChanged(user => {
                if (user) {
                    authContainer.style.display = 'none'; appContainer.style.display = 'flex';
                    document.getElementById('user-email').textContent = user.email;
                    initializeApplication();
                } else {
                    authContainer.style.display = 'flex'; appContainer.style.display = 'none';
                }
            });
            document.getElementById('sign-out-btn').addEventListener('click', () => auth.signOut());
            document.getElementById('login-button').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(e => document.getElementById('auth-error').textContent = e.message));
            document.getElementById('signup-button').addEventListener('click', () => auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value).catch(e => document.getElementById('auth-error').textContent = e.message));
            document.getElementById('toggle-auth-button').addEventListener('click', () => {
                const loginForm = document.getElementById('login-form'), signupForm = document.getElementById('signup-form');
                const isLogin = loginForm.style.display !== 'none';
                loginForm.style.display = isLogin ? 'none' : 'flex'; signupForm.style.display = isLogin ? 'flex' : 'none';
                document.getElementById('toggle-text').textContent = isLogin ? "Already have an account? " : "Don't have an account? ";
                document.getElementById('toggle-auth-button').textContent = isLogin ? "Log In" : "Sign Up";
            });

            function initializeApplication() {
                switchView('timeline-view'); renderTimeline(); createMapScrubber();
                applyTheme(localStorage.getItem('timelineTheme') || 'light');
            }

            const navItems = document.querySelectorAll('.nav-item'), views = document.querySelectorAll('.view');
            function switchView(viewId) {
                views.forEach(view => view.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                navItems.forEach(item => item.classList.toggle('active', item.dataset.view === viewId));
                
                const settingsFab = document.getElementById('settings-fab');
                settingsFab.style.display = (viewId === 'profile-view') ? 'flex' : 'none';

                if (viewId === 'map-view') {
                    const firstScrubberButton = document.querySelector('.scrubber-btn');
                    if (firstScrubberButton && !document.querySelector('.scrubber-btn.active')) {
                        firstScrubberButton.click();
                    }
                }
            }
            navItems.forEach(item => item.addEventListener('click', () => switchView(item.dataset.view)));

            const themeBtn = document.getElementById('theme-btn'), themeSubtext = document.getElementById('theme-subtext');
            function applyTheme(theme) { document.body.setAttribute('data-theme', theme); localStorage.setItem('timelineTheme', theme); themeSubtext.textContent = `${theme.charAt(0).toUpperCase() + theme.slice(1)} theme enabled`; }
            themeBtn.addEventListener('click', () => applyTheme((document.body.getAttribute('data-theme') || 'light') === 'light' ? 'dark' : 'light'));
            document.getElementById('settings-fab').addEventListener('click', () => alert("Settings clicked!"));

            const infoModal = document.getElementById('info-modal');
            infoModal.querySelector('.close-btn').addEventListener('click', () => infoModal.style.display = 'none');
            window.addEventListener('click', (e) => { if (e.target === infoModal) infoModal.style.display = 'none'; });
            function openInfoModal(title, body) {
                document.getElementById('info-modal-title').textContent = title;
                document.getElementById('info-modal-body').innerHTML = body;
                infoModal.style.display = 'block';
            }
            document.getElementById('about-btn').addEventListener('click', () => openInfoModal("About Aditya's Timeline", "<h4>Creator</h4><p>This application was created by <b>Aditya Kumar Rai</b> as a personal project to explore and visualize history in an interactive, AI-powered way.</p><h4>Technology</h4><p>This app utilizes Firebase for authentication and is powered by advanced AI models for generating historical data and analysis.</p><p><b>Version:</b> 8.0 (Secure Backend)</p>"));
            document.getElementById('privacy-btn').addEventListener('click', () => openInfoModal("Privacy Policy", "<h4>Data Storage</h4><p>Your personal activity data, such as explored events, is saved directly on your device in your browser's local storage. This data is <b>never sent to our servers or any third party</b>.</p><h4>Authentication</h4><p>We use Google Firebase for secure login. We only use your email for authentication purposes and it is never shared.</p><h4>AI Queries</h4><p>All requests made to the AI for historical data are completely anonymous and do not contain any of your personal information.</p>"));
            document.getElementById('guide-btn').addEventListener('click', () => openInfoModal("User Guide", "<h4>Welcome!</h4><p>This guide will help you navigate the app.</p><ul><li><b>Timeline:</b> Browse a curated list of major historical events. Click on any event to get a deep, AI-powered analysis.</li><li><b>Compare:</b> Enter any year (e.g., '1947 AD' or '44 BC') to see a list of simultaneous global events. Click on any event for a detailed Q&A.</li><li><b>Map:</b> Explore local historical maps for different years using the timeline scrubber at the top.</li><li><b>Profile:</b> Manage your app theme and view other information.</li></ul>"));

            // This function is no longer needed as all AI calls go through the backend
            // async function callAI(prompt) { ... }

            function setupInteractiveQA(container, title, year) {
                const qaPairs = container.querySelectorAll('.qa-pair');
                let currentIdx = 0;
                if (qaPairs.length === 0) return;
                const navButton = document.createElement('button');
                navButton.className = 'qa-navigation-btn';
                const buttonTexts = ["Reveal Next Insight", "Uncover the Next Layer", "Discover More", "Continue Exploring"];
                navButton.textContent = buttonTexts[0];
                container.appendChild(navButton);
                navButton.addEventListener('click', () => {
                    qaPairs[currentIdx]?.classList.remove('active');
                    currentIdx++;
                    if (currentIdx < qaPairs.length) {
                        qaPairs[currentIdx]?.classList.add('active');
                        navButton.textContent = buttonTexts[Math.floor(Math.random() * buttonTexts.length)];
                    } else {
                        navButton.textContent = 'All Insights Revealed';
                        navButton.disabled = true;
                    }
                });
            }
            
            async function handleAIInteraction(prompt, title, year) {
                openInfoModal(title, '<div class="loader"></div>');
                try {
                    // Humare naye backend function ka address
                    const detailsFunctionUrl = 'https://us-central1-las-card.cloudfunctions.net/getEventDetails';

                    const response = await fetch(detailsFunctionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: { event_prompt: prompt } }) // Firebase v2 requires this 'data' wrapper
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Server error: ${response.status} ${errorText}`);
                    }

                    const rawDetails = await response.text();
                    
                    const detailsMatch = rawDetails.match(/<div class="qa-pair.*">[\s\S]*/);
                    if (detailsMatch) {
                        let htmlContent = detailsMatch[0];
                        if (!htmlContent.includes('qa-pair active')) {
                            htmlContent = htmlContent.replace('<div class="qa-pair"', '<div class="qa-pair active"');
                        }
                        document.getElementById('info-modal-body').innerHTML = htmlContent;
                        setupInteractiveQA(document.getElementById('info-modal-body'), title, year);
                    } else {
                        // If AI gives a non-HTML response, show it as plain text
                        document.getElementById('info-modal-body').innerHTML = `<p>Received an unexpected response from the AI. Please try again.</p><pre>${rawDetails}</pre>`;
                    }
                } catch (error) { 
                    console.error("Details Error:", error);
                    document.getElementById('info-modal-body').innerHTML = `<p>Could not load details. Please try again.</p>`; 
                }
            }

            const timelineContainer = document.getElementById('timeline-container'), eraFilterButtons = document.querySelectorAll('.era-filter-btn');
            function renderTimeline() {
                const filter = document.querySelector('.era-filter-btn.active').dataset.era;
                const filteredData = (filter === 'All') ? timelineData : timelineData.filter(item => item.era === filter);
                timelineContainer.innerHTML = filteredData.sort((a, b) => a.year - b.year).map(item => `
                    <div class="timeline-item"><div class="timeline-item-dot"></div><div class="timeline-content" data-event-title="${item.title}" data-year="${item.year}">
                    <div class="timeline-year">${item.year < 0 ? `${Math.abs(item.year)} BC` : item.year}</div><h3 class="timeline-title">${item.title}</h3>
                    <div class="timeline-meta"><span>üìç ${item.location}</span><span class="era-tag era-${item.era}">${item.era}</span></div>
                    <p class="timeline-description">${item.description}</p></div></div>`).join('');
                document.querySelectorAll('.timeline-content').forEach(card => card.addEventListener('click', (e) => {
                    const title = e.currentTarget.dataset.eventTitle; const year = e.currentTarget.dataset.year;
                    handleAIInteraction(`"${title}"`, title, year);
                }));
            }
            eraFilterButtons.forEach(button => { button.addEventListener('click', (e) => { eraFilterButtons.forEach(btn => btn.classList.remove('active')); e.currentTarget.classList.add('active'); renderTimeline(); }); });
            
            // =========================================================================
            // ===== SAHI AUR FINAL CODE (BACKEND KO CALL KARNE WALA) =====
            // =========================================================================

            const searchYearInput = document.getElementById('search-year-input');
            const globalTimelineContainer = document.getElementById('global-timeline-container');
            const INITIAL_ENTITIES_TO_SHOW = 10;

            function parseYearString(yearStr) {
                if (!yearStr || typeof yearStr !== 'string') return null;
                const str = yearStr.trim().toUpperCase();
                const isBC = str.includes('BC');
                const numberPart = parseInt(str.replace(/BC|AD/g, '').trim());
                if (isNaN(numberPart)) return null;
                return isBC ? -numberPart : numberPart;
            }

            function handleYearSelection(yearStr) {
                const year = parseYearString(yearStr);
                if (year === null) {
                    alert("Invalid year format. Please use '1526 AD' or '44 BC'.");
                    return;
                }
                renderContinentSelectors(year);
                searchYearInput.value = yearStr;
            }

            function renderContinentSelectors(year) {
                globalTimelineContainer.innerHTML = '';
                const continents = ['Africa', 'Antarctica', 'Asia', 'Europe', 'North America', 'South America', 'Oceania'];
                const container = document.createElement('div');
                container.innerHTML = continents.map(continent => `
                    <div class="continent-selector-container">
                        <button class="continent-header continent-${continent.replace(/ /g, '_')}" data-continent="${continent}" data-year="${year}">
                            ${continent}
                        </button>
                        <div class="continent-events-container" id="events-${continent.replace(/ /g, '_')}"></div>
                    </div>
                `).join('');
                globalTimelineContainer.appendChild(container);

                document.querySelectorAll('button.continent-header').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const continentName = e.currentTarget.dataset.continent;
                        const year = e.currentTarget.dataset.year;
                        const resultsContainer = document.getElementById(`events-${continentName.replace(/ /g, '_')}`);
                        
                        if (resultsContainer.style.display !== 'none' && resultsContainer.innerHTML !== '') {
                            resultsContainer.style.display = 'none';
                        } else {
                            resultsContainer.style.display = 'block';
                            if (resultsContainer.innerHTML === '') {
                                startFetchingContinentData(year, continentName, resultsContainer);
                            }
                        }
                    });
                });
            }
            
            async function startFetchingContinentData(year, continent, container) {
                container.innerHTML = '<div class="loader"></div><p style="text-align: center; color: var(--subtle-text);">Contactando al historiador central...</p>';

                try {
                    // Yeh aapke live backend server ka address hai
                    const functionUrl = `https://us-central1-las-card.cloudfunctions.net/getHistoricEvents`;
                    const response = await fetch(`${functionUrl}?year=${year}&continent=${continent}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`El servidor respondi√≥ con un error: ${errorText}`);
                    }

                    const entitiesData = await response.json(); 

                    if (!entitiesData || entitiesData.length === 0) {
                        container.innerHTML = '<p>No se encontraron entidades pol√≠ticas significativas para este continente en el a√±o especificado.</p>';
                        return;
                    }
                    
                    renderAllEntities(entitiesData, container);

                } catch (error) {
                    console.error("Error al obtener datos hist√≥ricos desde el backend:", error);
                    container.innerHTML = `<p>No se pudieron cargar los datos para ${continent} en ${year}. Por favor, int√©ntalo de nuevo.</p>`;
                }
            }

            function renderAllEntities(entitiesData, container) {
                let htmlContent = entitiesData.map((entity, index) => {
                    const uniqueId = `entity-${(entity.name || 'unknown').replace(/[^a-zA-Z0-9]/g, '')}`;
                    const isHidden = index >= INITIAL_ENTITIES_TO_SHOW;
                    
                    let eventsHtml = '';
                    if (entity.events && entity.events.length > 0) {
                        eventsHtml = `<ul>${entity.events.map(event => `<li><a href="#" class="clickable-event" data-event-text="${(event || '').replace(/"/g, '&quot;')}">${event}</a></li>`).join('')}</ul>`;
                    } else {
                        eventsHtml = `<p class="event-placeholder">No se registraron eventos significativos para este a√±o.</p>`;
                    }

                    return `
                    <div class="country-timeline" id="${uniqueId}" ${isHidden ? 'style="display:none;"' : ''}>
                        <div class="country-header">
                            <img src="https://flagcdn.com/w40/${(entity.representative_modern_code || 'xx').toLowerCase()}.png" alt="${entity.representative_modern_code}">
                            <span>${entity.name}</span>
                        </div>
                        <div class="country-content">
                            ${eventsHtml}
                        </div>
                    </div>`;
                }).join('');

                if (entitiesData.length > INITIAL_ENTITIES_TO_SHOW) {
                    htmlContent += `<button class="show-more-btn">Mostrar ${entitiesData.length - INITIAL_ENTITIES_TO_SHOW} m√°s</button>`;
                }

                container.innerHTML = htmlContent;

                const showMoreBtn = container.querySelector('.show-more-btn');
                if (showMoreBtn) {
                    showMoreBtn.onclick = (e) => {
                        container.querySelectorAll('.country-timeline').forEach(el => {
                            el.style.display = 'block';
                        });
                        e.target.remove();
                    };
                }
            }
            
            globalTimelineContainer.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('clickable-event')) {
                    e.preventDefault();
                    const eventText = e.target.dataset.eventText;
                    const year = parseYearString(searchYearInput.value);
                    handleAIInteraction(`the event: "${eventText}"`, "Event Details", year);
                }
            });
            document.querySelectorAll('.year-btn').forEach(button => button.addEventListener('click', () => handleYearSelection(button.dataset.year)));
            searchYearInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleYearSelection(e.target.value); });
            
            let map2d, currentGeoJsonLayer, currentMarkerLayer;
            const mapTitleHeader = document.getElementById('map-title-header');
            const mapContainer = document.getElementById('map-container');
            const iframeContainer = document.getElementById('map-iframe-container');
            const iframe = document.getElementById('map-iframe');

            function createMapScrubber() {
                const container = document.getElementById('map-scrubber');
                container.innerHTML = Object.keys(mapFiles).map(label => `<button class="scrubber-btn" data-label="${label}">${label}</button>`).join('');
                container.querySelectorAll('.scrubber-btn').forEach(button => button.addEventListener('click', (e) => {
                    container.querySelectorAll('.scrubber-btn').forEach(btn => btn.classList.remove('active'));
                    const currentButton = e.currentTarget;
                    currentButton.classList.add('active');
                    const clickedLabel = currentButton.dataset.label;
                    const mapData = mapFiles[clickedLabel];

                    if(mapData.type !== 'iframe') {
                        if (mapContainer.style.display !== 'block') {
                            iframeContainer.style.display = 'none';
                            mapContainer.style.display = 'block';
                            iframe.src = 'about:blank'; 
                        }
                    } else {
                        if (iframeContainer.style.display !== 'block') {
                            mapContainer.style.display = 'none';
                            iframeContainer.style.display = 'block';
                        }
                    }

                    if (map2d) {
                        map2d.remove();
                        map2d = null;
                    }
                    
                    if (mapData.type !== 'iframe') {
                        initialize2DMapFeature();
                    }

                    switch(mapData.type) {
                        case 'iframe':
                            showIframeMap(mapData.url, clickedLabel, mapData.year);
                            break;
                        case 'markers':
                            showMarkerMap(mapData.key, clickedLabel, mapData.year);
                            break;
                        case 'base':
                             showBaseMap(clickedLabel, mapData.year);
                             break;
                        case 'geojson':
                        default:
                            showLeafletMap(mapData.url, clickedLabel, mapData.year);
                            break;
                    }
                    setTimeout(() => { if (map2d) map2d.invalidateSize() }, 20);
                }));
            }
            
            function showIframeMap(url, label, year) {
                mapTitleHeader.textContent = `Map for ${label} (${year})`;
                iframe.src = url;
            }

            function clearMapLayers() {
                if(map2d) {
                    if (currentGeoJsonLayer) map2d.removeLayer(currentGeoJsonLayer);
                    if (currentMarkerLayer) map2d.removeLayer(currentMarkerLayer);
                }
                currentGeoJsonLayer = null;
                currentMarkerLayer = null;
            }

            function showLeafletMap(url, label, year) {
                loadGeoJsonData(url, label, year);
            }

            function showMarkerMap(topicKey, label, year) {
                clearMapLayers();
                mapTitleHeader.textContent = `Map for ${label} (${year})`;

                const topic = markerData[topicKey];
                if (!topic || !map2d) return;

                const markers = [];
                topic.points.forEach(point => {
                    const marker = L.marker([point.lat, point.lng]);
                    marker.bindPopup(`<strong>${point.name}</strong><br>${point.description || ''}`);
                    markers.push(marker);
                });

                currentMarkerLayer = L.layerGroup(markers);
                currentMarkerLayer.addTo(map2d);
                map2d.setView(topic.view, topic.zoom);
            }
            
            function showBaseMap(label, year) {
                clearMapLayers();
                mapTitleHeader.textContent = `${label} (${year})`;
                if(map2d) map2d.setView([20, 0], 2);
            }

            function initialize2DMapFeature() {
                if (map2d) return;
                
                map2d = L.map('map-container', { zoomControl: true }).setView([40, 0], 2);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    maxZoom: 22
                }).addTo(map2d);
            }
            
            function getModernLocationForRomanProvince(provinceName) {
                const mapping = {
                    'Tarraconensis': 'Spain, Portugal', 'Lusitania': 'Portugal, Spain', 'Baetica': 'Spain',
                    'Aquitania': 'France', 'Lugdunensis': 'France', 'Belgica': 'Belgium, France', 'Narbonensis': 'France',
                    'Italia': 'Italy', 'Hispania': 'Spain, Portugal', 'Gallia': 'France, Belgium', 'Britannia': 'England, Wales',
                    'Germania Inferior': 'Netherlands, Germany', 'Germania Superior': 'Switzerland, France, Germany',
                    'Aegyptus': 'Egypt', 'Syria': 'Syria, Lebanon', 'Arabia Petraea': 'Jordan, Saudi Arabia',
                    'Achaia': 'Greece', 'Macedonia': 'Macedonia, Greece', 'Africa Proconsularis': 'Tunisia, Libya',
                    'Iudaea': 'Israel, Palestine', 'Dalmatia': 'Croatia, Bosnia', 'Noricum': 'Austria, Slovenia',
                    'Raetia': 'Switzerland, Germany, Austria', 'Pannonia': 'Hungary, Austria', 'Moesia': 'Serbia, Bulgaria',
                    'Dacia': 'Romania', 'Thracia': 'Bulgaria, Greece, Turkey', 'Bithynia et Pontus': 'Northern Turkey',
                    'Galatia': 'Central Turkey', 'Lycia et Pamphylia': 'Southern Turkey', 'Cilicia': 'Southeastern Turkey',
                    'Cappadocia': 'Eastern Turkey', 'Armenia': 'Armenia', 'Mesopotamia': 'Iraq, Syria', 'Assyria': 'Iraq',
                    'Asia': 'Western Turkey'
                };
                for (const key in mapping) {
                    if (provinceName && provinceName.includes(key)) return mapping[key];
                }
                return 'N/A';
            }
            
            function loadGeoJsonData(fileUrl, label, year) {
                clearMapLayers();
                mapTitleHeader.textContent = `Loading: ${label} (${year})...`;

                function getColorForCountry(countryName) {
                    let hash = 0;
                    if (!countryName) return '#CCCCCC'; 
                    for (let i = 0; i < countryName.length; i++) {
                        const char = countryName.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash |= 0; 
                    }
                    const hue = Math.abs(hash) % 360;
                    return `hsl(${hue}, 70%, 65%)`; 
                }

                fetch(fileUrl)
                    .then(response => { if (!response.ok) throw new Error(`Network response was not ok for: ${fileUrl}`); return response.json(); })
                    .then(data => {
                        mapTitleHeader.textContent = `Map for ${label} (${year})`;
                        currentGeoJsonLayer = L.geoJson(data, {
                            style: function(feature) {
                                const name = feature.properties.name || feature.properties.laq_name || feature.properties.NAME || feature.properties.ADMIN || feature.properties.PlateName || feature.properties.st_nm;
                                
                                if (label === 'Tectonic Plates') {
                                    return { color: '#E74C3C', weight: 2.5, fillOpacity: 0.0 };
                                }

                                if (name && (name.includes('Mare') || name.includes('Pontus Euxinus'))) {
                                    return { fillOpacity: 0.0, opacity: 0.0 };
                                }

                                const fillColor = getColorForCountry(name);
                                return {
                                    fillColor: fillColor,
                                    weight: 1.5,
                                    opacity: 1,
                                    color: 'white',
                                    fillOpacity: 0.6
                                };
                            },
                            onEachFeature: (feature, layer) => {
                                let name = feature.properties.name || feature.properties.laq_name || feature.properties.NAME || feature.properties.ADMIN || feature.properties.PlateName || feature.properties.st_nm;
                                
                                let popupContent = `<strong>${name || 'N/A'}</strong>`;

                                if (label.includes('Roman Empire')) {
                                    let displayName = name;
                                    if(name === 'Asia') {
                                        displayName = 'Asia (Roman Province)';
                                    }
                                    const modernLocation = getModernLocationForRomanProvince(name);
                                    popupContent = `<strong>${displayName}</strong><br>Modern Day: ${modernLocation}`;

                                } else if (label.includes('1914')) {
                                     if (name === 'Indian Empire') name = 'British India';
                                     if (name === 'Russia') name = 'Russian Empire';
                                     if (name === 'Manchu Empire' || name === 'Qing') name = 'Qing China';
                                     popupContent = `<strong>${name}</strong>`;
                                }

                                layer.bindPopup(popupContent);
                                
                                layer.on({
                                    mouseover: function (e) {
                                        var layer = e.target;
                                        if (layer.options.fillOpacity > 0 || label === 'Tectonic Plates') { 
                                            layer.setStyle({
                                                weight: 3,
                                                color: '#333',
                                                fillOpacity: 0.75
                                            });
                                        }
                                    },
                                    mouseout: function (e) {
                                        if(currentGeoJsonLayer) currentGeoJsonLayer.resetStyle(e.target);
                                    }
                                });
                            }
                        }).addTo(map2d);

                        if (currentGeoJsonLayer.getBounds().isValid()) {
                            if (label.includes('World & India Political Map')) {
                                map2d.setView([22.5, 82.0], 4.5);
                            } else {
                                map2d.fitBounds(currentGeoJsonLayer.getBounds());
                            }
                        }
                    })
                    .catch(error => { 
                        mapTitleHeader.textContent = `Error Loading Map`; 
                        alert(`Could not load map: ${label}. Please check the URL and your internet connection.`); 
                        console.error("Map loading error:", error); 
                    });
            }
        });
    </script>
</body>
</html>


